<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>CT Mentor — калькулятор маркировки</title>
  <meta name="color-scheme" content="light dark" />

  <style>
    /* ========= Brand tokens (фиксированные) ========= */
    :root{
      --brand: #ff6a00;              /* фирменный акцент */
      --brand-ink: #0b1220;          /* тёмный текст поверх светлых */
      --ok: #16a34a;
      --warn: #ef4444;

      /* Light */
      --bg: #f7f8fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #6b7280;
      --stroke: #e5e7eb;
      --field: #ffffff;
      --shadow: 0 10px 30px rgba(2,6,23,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #101828;
        --ink: #e5e7eb;
        --muted: #94a3b8;
        --stroke: #1f2937;
        --field: #0f172a;
        --shadow: 0 8px 28px rgba(0,0,0,.5);
      }
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font: 15px/1.4 -apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,"Noto Sans",sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 1100px; margin: 18px auto 36px; padding: 0 14px;
    }
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:20px;
      box-shadow: var(--shadow); overflow: hidden;
    }

    .header{
      display:flex; align-items:center; gap:12px; padding:18px 18px 6px;
    }
    .title{
      font-size:20px; font-weight:800; letter-spacing:.2px;
    }
    .sub{
      margin-top:2px; color:var(--muted); font-size:12px;
    }

    /* Controls row */
    .controls{
      display:flex; gap:12px; flex-wrap:wrap; padding:12px 18px 2px;
      align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--stroke); background:var(--field);
      border-radius:12px; font-weight:600;
    }
    .select, .btn, .input{
      appearance:none; outline:none; border:1.5px solid var(--stroke);
      background:var(--field); color:var(--ink);
      border-radius:12px; padding:10px 12px; font-weight:700;
      transition:.15s border-color ease, .15s transform ease;
    }
    .select:focus,.input:focus{ border-color:var(--brand); }
    .btn{
      background: var(--brand);
      color:white; border-color:transparent;
      padding:11px 16px; font-weight:800; letter-spacing:.2px;
      box-shadow: 0 10px 25px rgba(255,106,0,.35);
      cursor:pointer; user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }

    .rates{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px dashed var(--stroke);
      background:var(--field); border-radius:12px;
      color:var(--muted); font-weight:700;
    }
    .link{ color:var(--muted); text-decoration:underline; cursor:pointer; }

    /* Table */
    table{ width:100%; border-collapse: collapse; }
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:12px 16px; background:rgba(148,163,184,.08);
      border-bottom:1px solid var(--stroke);
    }
    tbody td{
      padding:14px 16px; border-bottom:1px solid var(--stroke);
      vertical-align: middle;
    }

    .qty{
      width:110px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .qty .input{ width:100%; text-align:center; font-variant-numeric: tabular-nums; }

    .tag{ color:var(--muted); font-weight:700; }

    /* Totals pane */
    .totals{
      display:flex; justify-content:flex-end; padding:14px 18px 22px;
    }
    .totals .box{
      width:360px; background:var(--card); border:1px solid var(--stroke);
      border-radius:16px; overflow:hidden; box-shadow: var(--shadow);
    }
    .row{
      display:flex; justify-content:space-between; padding:12px 14px;
      font-weight:800;
    }
    .row.dim{ color:var(--muted); background:rgba(148,163,184,.08); }
    .row.total{
      background: var(--brand); color:white; letter-spacing:.3px;
      box-shadow: inset 0 -1px rgba(255,255,255,.15);
    }

    .hint{
      margin:8px 18px 18px; color:var(--muted); font-size:12px;
    }
    .ok{ color: var(--ok); font-weight:800; }
    .spin{
      width:14px; height:14px; border-radius:50%;
      border:2px solid var(--stroke); border-top-color: var(--brand);
      animation: r .8s linear infinite;
    }
    @keyframes r{ to{ transform: rotate(360deg); } }

    .right{ margin-left:auto; display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <div class="title">Калькулятор услуг по маркировке</div>
        <div class="sub">Отображение сумм в выбранной валюте (по умолчанию RUB)</div>
      </div>
      <div class="right">
        <div id="emailView" class="chip">e-mail: <span id="emailText">—</span></div>
        <button id="btnChangeEmail" class="select">сменить e-mail</button>
        <button id="btnSend" class="btn">Получить расчёт</button>
      </div>
    </div>

    <div class="controls">
      <div class="chip">Ставка НДС: <select id="vat" class="select">
        <option value="20%">20%</option><option value="0%">0%</option>
      </select></div>

      <div class="chip">Валюта: <select id="currency" class="select">
        <option value="RUB">RUB</option><option value="USD">USD</option>
        <option value="EUR">EUR</option><option value="CNY">CNY</option>
      </select></div>

      <div class="rates">
        <span id="ratesText">Курсы ЦБ РФ: —</span>
        <button id="btnRates" class="select">Обновить</button>
        <span id="ratesState" class="ok" hidden>обновлено</span>
      </div>
    </div>

    <div style="padding: 10px 0 0;">
      <table>
        <thead>
        <tr>
          <th>НАИМЕНОВАНИЕ</th>
          <th>СТОИМОСТЬ</th>
          <th>КОЛИЧЕСТВО</th>
          <th>ЕД.</th>
          <th>СУММА</th>
          <th>НАЛОГ</th>
          <th>ИТОГО</th>
        </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="box">
        <div class="row dim"><span>Без НДС</span><span id="sumNoVat">0,00 ₽</span></div>
        <div class="row dim"><span>НДС</span><span id="sumVat">0,00 ₽</span></div>
        <div class="row total"><span>ИТОГО</span><span id="sumTotal">0,00 ₽</span></div>
      </div>
    </div>

    <div class="hint">PDF придёт в этот чат, а при указанном e-mail — ещё и на почту.</div>
  </div>
</div>

<script>
  // ---------------- Data ----------------
  const tg = window.Telegram?.WebApp;
  tg?.expand();

  const money = (n, cur) => (new Intl.NumberFormat('ru-RU', {
    minimumFractionDigits:2, maximumFractionDigits:2
  }).format(+n)) + ' ' + (cur==='RUB'?'₽':cur);

  const SERVICES = [
    {title:'Получение GTIN и КМ (контракт агента)',              price:0.60, unit:'шт'},
    {title:'Формирование PDF с КМ (если контракт агента — бесплатно)', price:3.00, unit:'шт'},
    {title:'Подключение МЧД, получение GTIN и КМ в ЛК клиента',  price:15000, unit:'фикс'},
    {title:'Консультация по вопросам маркировки, УПД',           price:2500, unit:'ч'},
    {title:'Пакетирование',                                      price:1.50, unit:'шт'},
    {title:'Создание шаблона этикеток',                           price:2000, unit:'фикс'},
    {title:'Оформление карточек в НКТ',                           price:2.00, unit:'шт'},
    {title:'Регистрация в ЧЗ/GS1 РУС',                            price:15000, unit:'фикс'}
  ];

  // Курсы (для примера просто храню коэффициенты относительно RUB)
  let RATES = { USD: 83.61, EUR: 97.68, CNY: 11.68, RUB: 1 };

  // state
  const state = {
    email: localStorage.getItem('ctm_email') || '',
    vat: localStorage.getItem('ctm_vat') || '20%',
    currency: localStorage.getItem('ctm_cur') || 'RUB',
    qty: JSON.parse(localStorage.getItem('ctm_qty') || '[]') || []
  };

  // ---------------- UI binding ----------------
  const rowsEl = document.getElementById('rows');
  const sumNoVat = document.getElementById('sumNoVat');
  const sumVat   = document.getElementById('sumVat');
  const sumTotal = document.getElementById('sumTotal');
  const emailText= document.getElementById('emailText');
  const ratesText= document.getElementById('ratesText');
  const ratesState= document.getElementById('ratesState');

  const vatSel = document.getElementById('vat');
  const curSel = document.getElementById('currency');

  vatSel.value = state.vat;
  curSel.value = state.currency;
  emailText.textContent = state.email || '—';

  function priceInCurrency(priceRub, cur){
    if(cur==='RUB') return priceRub;
    // RUB -> cur
    const rate = RATES[cur] || 1;
    return priceRub / (1/RATES['RUB']) / (1/rate);
  }

  function render(){
    rowsEl.innerHTML = '';
    SERVICES.forEach((s, i)=>{
      const qty = +((state.qty[i] ?? 0) || 0);
      const price = priceInCurrency(s.price, state.currency);
      const sum   = price * qty;
      const vat   = (state.vat.startsWith('20') ? sum*0.2 : 0);
      const itogo = sum + vat;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.title}</td>
        <td><b>${money(price, state.currency)}</b></td>
        <td>
          <div class="qty">
            <input class="input" type="number" min="0" step="1" value="${qty}">
          </div>
        </td>
        <td class="tag">${s.unit}</td>
        <td><b>${money(sum, state.currency)}</b></td>
        <td>${money(vat, state.currency)}</td>
        <td><b>${money(itogo, state.currency)}</b></td>
      `;
      const input = tr.querySelector('input');
      input.addEventListener('input', ()=>{
        const v = Math.max(0, Math.floor(+input.value || 0));
        state.qty[i] = v;
        localStorage.setItem('ctm_qty', JSON.stringify(state.qty));
        render();
      });
      rowsEl.appendChild(tr);
    });

    // totals
    let subtotal = 0;
    SERVICES.forEach((s, i)=>{
      const qty = +((state.qty[i] ?? 0) || 0);
      const price = priceInCurrency(s.price, state.currency);
      subtotal += price * qty;
    });
    const vat = state.vat.startsWith('20') ? subtotal * 0.2 : 0;
    const total = subtotal + vat;

    sumNoVat.textContent = money(subtotal, state.currency);
    sumVat.textContent   = money(vat, state.currency);
    sumTotal.textContent = money(total, state.currency);
  }

  render();

  vatSel.addEventListener('change', ()=>{
    state.vat = vatSel.value;
    localStorage.setItem('ctm_vat', state.vat);
    render();
  });
  curSel.addEventListener('change', ()=>{
    state.currency = curSel.value;
    localStorage.setItem('ctm_cur', state.currency);
    render();
  });

  // Обновление курсов (демо: просто меняем дату/индикатор)
  document.getElementById('btnRates').addEventListener('click', async ()=>{
    ratesState.hidden = false;
    ratesState.textContent = '';
    const spinner = document.createElement('span');
    spinner.className='spin';
    ratesState.appendChild(spinner);

    try{
      // тут бы ты подтянул реальные курсы; ниже — заглушка
      await new Promise(res=>setTimeout(res, 700));
      const dt = new Date();
      ratesText.textContent =
        `Курсы ЦБ РФ: USD ${RATES.USD} • EUR ${RATES.EUR} • CNY ${RATES.CNY} от ${dt.toLocaleDateString('ru-RU')}`;
      ratesState.textContent = 'обновлено';
    }catch(e){
      ratesState.textContent = 'ошибка';
      ratesState.style.color = 'var(--warn)';
    }finally{
      setTimeout(()=>{ ratesState.hidden = true; }, 1200);
      render();
    }
  });

  // Смена e-mail
  document.getElementById('btnChangeEmail').addEventListener('click', async ()=>{
    const v = prompt('Укажите e-mail для отправки PDF (опционально):', state.email || '');
    if(v !== null){
      state.email = (v||'').trim();
      emailText.textContent = state.email || '—';
      localStorage.setItem('ctm_email', state.email);
    }
  });

  // Отправка расчёта
  document.getElementById('btnSend').addEventListener('click', ()=>{
    const subtotal = SERVICES.reduce((acc, s, i)=>{
      const price = priceInCurrency(s.price, state.currency);
      const qty = +((state.qty[i] ?? 0) || 0);
      return acc + price * qty;
    }, 0);
    const vat = state.vat.startsWith('20') ? subtotal * 0.2 : 0;
    const total = subtotal + vat;

    const payload = {
      email: state.email,
      currency: state.currency,
      vat: state.vat,
      rates: ratesText.textContent,
      rows: SERVICES.map((s, i)=>({
        title:s.title,
        price: priceInCurrency(s.price, state.currency),
        qty: +((state.qty[i] ?? 0) || 0),
        unit: s.unit
      })),
      totals: { subtotal, vat, total },
      ts: new Date().toISOString()
    };

    try{
      tg?.HapticFeedback?.notificationOccurred?.('success');
      tg?.sendData(JSON.stringify({type:'order', payload}));
      // чтобы Telegram Desktop/Web не "залипал" при повторном открытии
      setTimeout(()=> tg?.close && tg.close(), 120);
    }catch(e){
      alert('Не удалось передать данные в бота. Откройте калькулятор из Telegram.');
      console.error(e);
    }
  });

  // Первый прогон текста курсов
  (function initRates(){
    const dt = new Date();
    ratesText.textContent =
      `Курсы ЦБ РФ: USD ${RATES.USD} • EUR ${RATES.EUR} • CNY ${RATES.CNY} от ${dt.toLocaleDateString('ru-RU')}`;
  })();
</script>
</body>
</html>
