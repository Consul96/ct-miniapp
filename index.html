<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор услуг маркировки — Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ===== TOKENS ===== */
    :root{
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --line:#E2E8F0;
      --text:#0F172A;
      --muted:#475569;
      --accent:#FF7A00;        /* фирменный */
      --accent-500:#F97316;    /* кнопки/инпуты */
      --accent-weak:#FFF7ED;   /* фон шапки таблицы */

      --font:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --fs-12:12px; --fs-14:14px; --fs-16:16px; --fs-18:18px;

      --r-sm:10px; --r-md:12px; --r-lg:16px;
      --shadow-card:0 10px 30px rgba(2,6,23,.08);

      --vat:0.20;
    }

    /* ===== BASE ===== */
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    .wrap{min-height:100dvh;display:flex;justify-content:center;padding:clamp(12px,2.5vw,24px)}
    .container{
      width:clamp(320px,96vw,1200px);
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--r-lg); box-shadow:var(--shadow-card); overflow:hidden;
    }

    /* ===== HEADER ===== */
    .header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
    .h-left h1{margin:0;font-size:var(--fs-18)}
    .h-left small{display:block;margin-top:4px;color:var(--muted);font-size:var(--fs-12)}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--r-md);
      background:var(--accent-500);border:1px solid var(--accent-500);color:#fff;font-weight:700;cursor:pointer
    }
    .btn:active{transform:translateY(1px)}

    /* ===== CHIP BAR ===== */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:12px 20px;border-bottom:1px solid var(--line);background:#fff}
    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:20px;
      background:var(--accent-weak);border:1px solid var(--line);font-size:var(--fs-12);font-weight:600
    }
    .toolbar .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .link{color:var(--muted);text-decoration:underline;cursor:pointer}

    /* ===== TABLE ===== */
    .table-wrap{overflow-x:auto}
    .table{min-width:860px;width:100%;border-collapse:collapse;table-layout:fixed;font-size:var(--fs-14)}
    .table thead th{
      background:var(--accent-weak); color:var(--muted); text-transform:uppercase; letter-spacing:.02em;
      padding:12px 14px; text-align:left; font-size:var(--fs-12); border-bottom:1px solid var(--line)
    }
    .table tbody td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
    .col-name{width:46%}.col-price{width:14%}.col-qty{width:12%}.col-unit{width:8%}.col-sum{width:8%}.col-vat{width:6%}.col-total{width:6%}

    .input{
      width:100%;height:36px;box-sizing:border-box;background:#fff;font-size:var(--fs-14);
      border-radius:var(--r-md);padding:0 10px;border:1px solid var(--accent-500)
    }
    .input:focus{outline:none;box-shadow:0 0 0 3px rgba(249,115,22,.15)}

    /* ===== TOTALS ===== */
    .totals{padding:16px 20px 24px;display:flex;justify-content:flex-end}
    .totals-col{width:320px;display:grid;gap:8px}
    .badge{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 14px;border-radius:10px;background:var(--accent-500);color:#fff;font-weight:700
    }
    .badge span{opacity:.92;font-weight:600}
    .muted{color:var(--muted)}

    /* ===== MOBILE ===== */
    @media (max-width:900px){
      .header{padding:12px 14px}
      .toolbar{padding:10px 14px}
      .table thead th,.table tbody td{padding:10px 12px}
      .btn{padding:9px 12px}
    }
    @media (max-width:600px){
      .h-left h1{font-size:16px}
      .totals{justify-content:stretch}
      .totals-col{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="h-left">
          <h1>Калькулятор услуг по маркировке</h1>
          <small>Отображение сумм в выбранной валюте (по умолчанию RUB)</small>
        </div>
        <button class="btn" id="btnCalc">Получить расчёт</button>
      </div>

      <!-- Chips -->
      <div class="toolbar">
        <div class="chip">Ставка НДС: <strong id="chipVat">20%</strong></div>
        <div class="chip">Валюта: <strong>RUB</strong></div>

        <div class="right">
          <input id="email" type="email" placeholder="email для счёта"
                 class="input" style="width:220px;height:34px">
          <span class="chip" id="btnRefresh" style="background:#fff">Обновить</span>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <table class="table" id="priceTable">
          <colgroup>
            <col class="col-name"><col class="col-price"><col class="col-qty">
            <col class="col-unit"><col class="col-sum"><col class="col-vat"><col class="col-total">
          </colgroup>
          <thead>
            <tr>
              <th>Наименование</th>
              <th>Стоимость</th>
              <th>Количество</th>
              <th>Ед. измерения</th>
              <th>Сумма</th>
              <th>Налог</th>
              <th>Итого</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Totals -->
      <div class="totals">
        <div class="totals-col">
          <div class="badge"><span>Без НДС</span><strong id="sumNoVat">0 ₽</strong></div>
          <div class="badge"><span>НДС</span><strong id="sumVat">0 ₽</strong></div>
          <div class="badge"><span>ИТОГО</span><strong id="sumTotal">0 ₽</strong></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const VAT = 0.20;
    const pdfRate = q => q>=10000?12 : q>=5000?15 : q>=2000?18 : q>=1000?20 : q>=500?25 : 30;

    const rows = [
      { key:'gtin_km', title:'Получение GTIN и КМ (контракт агента)', unit:'шт', price:0.60 },
      { key:'pdf',     title:'Формирование PDF с КМ (если контракт агента — бесплатно)', unit:'шт', priceFn:q=>pdfRate(q) },
      { key:'mdlp',    title:'Подключение МЧД, получение GTIN и КМ в ЛК клиента', unit:'шт', price:15000, fixed:true },
      { key:'consult', title:'Консультация по вопросам маркировки, УПД', unit:'ч',  price:2500 },
      { key:'pack',    title:'Пакетирование', unit:'шт', price:1.50 },
      { key:'tpl',     title:'Создание шаблона этикеток', unit:'фикс', price:2000, fixed:true },
      { key:'nkt',     title:'Оформление карточек в НКТ', unit:'шт', price:2.00 },
      { key:'reg',     title:'Регистрация в ЧЗ/GS1 РУС', unit:'фикс', price:15000, fixed:true },
    ];

    const tbody = document.querySelector('#priceTable tbody');
    const money = n => (n||0).toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:2});

    function draw(){
      tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');

        const qty = document.createElement('input');
        qty.className='input'; qty.type='number'; qty.min='0'; qty.value=r.qty||0;
        qty.oninput = ()=>{ r.qty=+qty.value; redrawRow(tr,r); recalc(); };

        function redrawRow(el,row){
          const price = (row.priceFn ? row.priceFn(row.qty||0) : row.price)||0;
          const rowSum = (row.fixed ? price : price*(row.qty||0));
          const rowVat = rowSum*VAT;

          el.innerHTML = `
            <td>${row.title}</td>
            <td>${price? money(price) + (row.fixed?'':' / шт') : '—'}</td>
            <td></td>
            <td>${row.unit}</td>
            <td>${money(rowSum)}</td>
            <td>${money(rowVat)}</td>
            <td>${money(rowSum+rowVat)}</td>
          `;
          el.children[2].appendChild(qty);
          el.dataset.sum=rowSum; el.dataset.vat=rowVat;
        }

        redrawRow(tr,r);
        tbody.appendChild(tr);
      });
      recalc();
    }

    function recalc(){
      let sum=0,vat=0;
      tbody.querySelectorAll('tr').forEach(tr=>{
        sum+=Number(tr.dataset.sum||0); vat+=Number(tr.dataset.vat||0);
      });
      document.getElementById('sumNoVat').textContent = money(sum);
      document.getElementById('sumVat').textContent   = money(vat);
      document.getElementById('sumTotal').textContent = money(sum+vat);
    }

    function collectPayload(){
      const items = [];
      document.querySelectorAll('#priceTable tbody tr').forEach(tr=>{
        const title = tr.children[0].textContent.trim();
        const priceText = tr.children[1].textContent.trim();
        const qty = Number(tr.querySelector('input')?.value || 0);
        const unit = tr.children[3].textContent.trim();
        const sumText = tr.children[4].textContent.trim();
        // фикс-позиции тоже полезно отправлять
        if(qty>0 || priceText==='—' || /фикс/i.test(unit)){
          items.push({title, price:priceText, qty, unit, sum:sumText});
        }
      });
      return {
        email: (document.getElementById('email')?.value || '').trim(),
        sumNoVat: document.getElementById('sumNoVat').textContent,
        vat:     document.getElementById('sumVat').textContent,
        total:   document.getElementById('sumTotal').textContent,
        items,
        vat_rate: 20
      };
    }

    draw();

    document.getElementById('btnCalc').onclick = ()=>{
      const payload = collectPayload();
      try{ Telegram.WebApp.HapticFeedback?.impactOccurred('soft'); }catch(e){}
      Telegram.WebApp.ready?.();
      Telegram.WebApp.sendData(JSON.stringify(payload)); // уходит в бота
    };
    document.getElementById('btnRefresh').onclick = ()=> location.reload();
  </script>
</body>
</html>
