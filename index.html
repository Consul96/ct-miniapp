<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>CT Mentor — калькулятор</title>
  <link rel="preconnect" href="https://telegram.org">
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --muted:#64748b; --text:#0f172a;
      --accent:#f97316; --accent-600:#ea580c; --line:#e2e8f0;
      --ring:0 0 0 2px rgba(249,115,22,.2);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:12px auto;padding:8px 10px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 2px 14px rgba(15,23,42,.06);padding:14px}
    h1{font-size:18px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
    select, input[type=number]{border:1px solid #fb923c;border-radius:12px;padding:10px 14px;font:inherit;width:120px;outline:none}
    input[type=number]{width:84px;text-align:center}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.link{background:transparent;color:#2563eb;padding:0;border-radius:0}
    .rates{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
    .table{margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .thead,.row{display:grid;grid-template-columns:1fr 120px 120px 90px 110px 110px 110px;gap:8px;align-items:center}
    .thead{background:#fff7ed;color:#334155;font-weight:600;border-bottom:1px solid var(--line);padding:10px 12px}
    .row{background:#fff;border-bottom:1px solid var(--line);padding:10px 12px}
    .row:nth-child(2n){background:#fdfdfd}
    .qty{display:flex;justify-content:center}
    .sum,.tax,.total{text-align:right}
    .totals{margin-top:16px}
    .pill{display:flex;justify-content:space-between;align-items:center;background:var(--accent);color:#fff;border-radius:14px;padding:14px 16px;font-weight:700;margin-top:8px}
    .pill.muted{background:#f1f5f9;color:#0f172a;font-weight:600}
    .foot{font-size:12px;color:var(--muted);margin-top:10px}
    @media (max-width:860px){
      .thead,.row{grid-template-columns:1fr 110px 110px 80px 100px 100px 100px}
      select{width:100px}
    }
    @media (max-width:680px){
      .wrap{padding:6px}
      .thead,.row{grid-template-columns:1fr 96px 96px 70px 92px 92px 92px}
      input[type=number]{width:72px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;align-items:start;justify-content:space-between;gap:12px">
        <div>
          <h1>Калькулятор услуг по маркировке</h1>
          <div class="sub">Отображение сумм в выбранной валюте (по умолчанию RUB)</div>
        </div>
        <button id="sendBtn" class="btn">Получить расчёт</button>
      </div>

      <div class="toolbar" style="margin:8px 0 6px">
        <span class="chip">Ставка НДС:
          <select id="vatSel">
            <option value="0">0%</option>
            <option value="10">10%</option>
            <option value="20" selected>20%</option>
          </select>
        </span>
        <span class="chip">Валюта:
          <select id="curSel">
            <option value="RUB" selected>RUB</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="CNY">CNY</option>
          </select>
        </span>
        <span id="rates" class="rates">Курсы ЦБ РФ: USD — • EUR — • CNY —</span>
        <button id="refreshBtn" class="btn" style="padding:8px 12px">Обновить</button>
        <button id="changeEmail" class="btn link" type="button">сменить e-mail</button>
      </div>

      <div class="table">
        <div class="thead">
          <div>НАИМЕНОВАНИЕ</div><div class="sum">СТОИМОСТЬ</div><div class="qty">КОЛИЧЕСТВО</div><div class="qty">ЕД.</div><div class="sum">СУММА</div><div class="sum">НАЛОГ</div><div class="sum">ИТОГО</div>
        </div>
        <div id="rows"></div>
      </div>

      <div class="totals">
        <div class="pill muted"><span>Без НДС</span><span id="subTotal">0,00 ₽</span></div>
        <div class="pill muted"><span>НДС</span><span id="vatTotal">0,00 ₽</span></div>
        <div class="pill"><span>ИТОГО</span><span id="grandTotal">0,00 ₽</span></div>
      </div>

      <div class="foot">PDF придёт в этот чат, а при указанном e-mail — ещё и на почту.</div>
    </div>
  </div>

  <script>
  // --- Telegram bootstrap
  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

  // --- цены в RUB (база)
  const ITEMS = [
    { id:'gtin_km',         title:'Получение GTIN и КМ (контракт агента)',                         unit:'шт',  price:0.60 },
    { id:'pdf_km',          title:'Формирование PDF с КМ (если контракт агента — бесплатно)',     unit:'шт',  price:3.00 },
    { id:'mchd',            title:'Подключение МЧД, получение GTIN и КМ в ЛК клиента',            unit:'фикс',price:15000 },
    { id:'consult',         title:'Консультация по вопросам маркировки, УПД',                     unit:'ч',   price:2500 },
    { id:'pack',            title:'Пакетирование',                                                 unit:'шт',  price:1.50 },
    { id:'label_tmpl',      title:'Создание шаблона этикеток',                                    unit:'фикс',price:2000 },
    { id:'nkt_cards',       title:'Оформление карточек в НКТ',                                    unit:'шт',  price:2.00 },
    { id:'chz_gs1',         title:'Регистрация в ЧЗ/GS1 РУС',                                     unit:'фикс',price:15000 },
  ];

  // --- состояние
  let state = {
    vat: 20,
    cur: 'RUB',
    rates: { USD:83.61, EUR:97.68, CNY:11.68, date:'—' },
    qty: Object.fromEntries(ITEMS.map(i=>[i.id,0])),
    email: ''
  };

  // --- helpers
  const fmt = (n, cur) => new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur}).format(n);
  const byCur = (rub, cur, R) => {
    if (cur==='RUB') return rub;
    if (cur==='USD') return rub / (R.USD||1);
    if (cur==='EUR') return rub / (R.EUR||1);
    if (cur==='CNY') return rub / (R.CNY||1);
    return rub;
  };
  const priceInCur = (rub) => byCur(rub, state.cur, state.rates);

  function ratesText() {
    return `Курсы ЦБ РФ: USD ${state.rates.USD?.toFixed(2)} • EUR ${state.rates.EUR?.toFixed(2)} • CNY ${state.rates.CNY?.toFixed(2)} от ${state.rates.date||'—'}`;
  }

  // --- CloudStorage <-> state
  async function loadCloud() {
    if (!tg?.CloudStorage) return;
    try {
      const keys = ['email','vat','cur','qty','rates'];
      const res = await tg.CloudStorage.getItems(keys);
      if (res?.email) state.email = res.email;
      if (res?.vat)   state.vat   = +res.vat || 20;
      if (res?.cur)   state.cur   = res.cur;
      if (res?.qty)   state.qty   = JSON.parse(res.qty);
      if (res?.rates) state.rates = JSON.parse(res.rates);
    } catch(e){ console.warn('CloudStorage getItems:', e); }
  }
  async function saveCloud(patch={}) {
    Object.assign(state, patch);
    try {
      if (!tg?.CloudStorage) return;
      await tg.CloudStorage.setItems({
        email: state.email || '',
        vat:   String(state.vat),
        cur:   state.cur,
        qty:   JSON.stringify(state.qty),
        rates: JSON.stringify(state.rates)
      });
    } catch(e){ console.warn('CloudStorage setItems:', e); }
  }

  // --- UI
  const rowsEl = document.getElementById('rows');
  const subEl  = document.getElementById('subTotal');
  const vatEl  = document.getElementById('vatTotal');
  const grdEl  = document.getElementById('grandTotal');
  const curSel = document.getElementById('curSel');
  const vatSel = document.getElementById('vatSel');
  const ratesBadge = document.getElementById('rates');
  const sendBtn = document.getElementById('sendBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  function renderRows(){
    rowsEl.innerHTML = '';
    ITEMS.forEach(it=>{
      const price = priceInCur(it.price);
      const qty = state.qty[it.id]||0;
      const sum = price*qty;
      const tax = sum * (state.vat/100);
      const tot = sum + tax;

      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div>${it.title}</div>
        <div class="sum" data-price-id="${it.id}">${fmt(price, state.cur)}</div>
        <div class="qty"><input type="number" min="0" step="${it.unit==='ч'? '0.5' : '1'}" value="${qty}" data-qty-id="${it.id}"></div>
        <div class="qty">${it.unit}</div>
        <div class="sum" data-sum-id="${it.id}">${fmt(sum, state.cur)}</div>
        <div class="sum" data-tax-id="${it.id}">${fmt(tax, state.cur)}</div>
        <div class="sum" data-tot-id="${it.id}">${fmt(tot, state.cur)}</div>
      `;
      rowsEl.appendChild(row);
    });

    rowsEl.querySelectorAll('input[data-qty-id]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const id = e.target.dataset.qtyId;
        const val = Math.max(0, +e.target.value || 0);
        state.qty[id] = val;
        recalc();
        saveCloud();
      });
    });
  }

  function recalc(){
    let sub=0, tax=0;
    ITEMS.forEach(it=>{
      const price = priceInCur(it.price);
      const qty = state.qty[it.id]||0;
      const s = price * qty;
      const t = s * (state.vat/100);
      sub += s; tax += t;
      rowsEl.querySelector(`[data-price-id="${it.id}"]`).textContent = fmt(price, state.cur);
      rowsEl.querySelector(`[data-sum-id="${it.id}"]`).textContent   = fmt(s, state.cur);
      rowsEl.querySelector(`[data-tax-id="${it.id}"]`).textContent   = fmt(t, state.cur);
      rowsEl.querySelector(`[data-tot-id="${it.id}"]`).textContent   = fmt(s+t, state.cur);
    });
    subEl.textContent = fmt(sub, state.cur);
    vatEl.textContent = fmt(tax, state.cur);
    grdEl.textContent = fmt(sub+tax, state.cur);
    ratesBadge.textContent = ratesText();
  }

  // --- init
  (async function init(){
    try {
      // 1) загрузить CloudStorage
      await loadCloud();

      // 2) применить в селекты
      curSel.value = state.cur;
      vatSel.value = String(state.vat);

      // 3) отрисовать
      renderRows(); recalc();
    } catch(e){
      console.error(e);
      tg?.showAlert?.('Ошибка инициализации: '+e.message);
    }
  })();

  // --- handlers
  curSel.addEventListener('change', async e=>{
    state.cur = e.target.value;
    recalc(); await saveCloud();
  });
  vatSel.addEventListener('change', async e=>{
    state.vat = +e.target.value || 0;
    recalc(); await saveCloud();
  });

  document.getElementById('changeEmail').addEventListener('click', (e)=>{
    e.preventDefault();
    // Внутренняя навигация (не внешний браузер!)
    location.href = './auth.html';
  });

  refreshBtn.addEventListener('click', async ()=>{
    try{
      refreshBtn.disabled = true;
      refreshBtn.textContent = '...';
      const r = await fetch('https://www.cbr-xml-daily.ru/daily_json.js',{cache:'no-store'});
      const j = await r.json();
      const USD = j.Valute.USD.Value;
      const EUR = j.Valute.EUR.Value;
      const CNY = j.Valute.CNY.Value;
      state.rates = { USD, EUR, CNY, date: (j.Date||'').slice(0,10).split('-').reverse().join('.') };
      await saveCloud();
      recalc();
      refreshBtn.textContent = '✓ Обновлено';
      setTimeout(()=>{ refreshBtn.textContent='Обновить'; refreshBtn.disabled=false; }, 1200);
    }catch(e){
      refreshBtn.disabled=false; refreshBtn.textContent='Обновить';
      tg?.showAlert?.('Не удалось обновить курсы: '+e.message);
    }
  });

  sendBtn.addEventListener('click', async ()=>{
    try{
      sendBtn.disabled = true;
      const payload = {
        email: state.email || '',
        currency: state.cur,
        vat: state.vat + '%',
        rates: `USD ${state.rates.USD?.toFixed(2)} · EUR ${state.rates.EUR?.toFixed(2)} · CNY ${state.rates.CNY?.toFixed(2)} от ${state.rates.date||'—'}`,
        rows: ITEMS.map(it=>({ title: it.title, unit: it.unit, price: +priceInCur(it.price).toFixed(2), qty: state.qty[it.id]||0 })),
      };
      // фильтруем пустые позиции
      payload.rows = payload.rows.filter(r=>r.qty>0 || r.unit==='фикс');

      tg?.sendData?.(JSON.stringify({ type:'order', payload }));
      tg?.showPopup?.({ title:'Отправлено', message:'PDF придёт в чат. Если указан e-mail — продублируем на почту.', buttons:[{type:'ok'}] });
    }catch(e){
      tg?.showAlert?.('Не удалось отправить: '+e.message);
    }finally{
      sendBtn.disabled = false;
    }
  });

  // ловим глобальные ошибки
  window.addEventListener('error', (e)=>console.error('window.error', e.message));
  </script>
</body>
</html>
